name: Automated Commit Review

on:
  push:
    branches:
      - '**'

jobs:
  start-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Start review on pushed commits
        uses: actions/github-script@v7
        with:
          script: |
            if (context.payload.deleted) {
              core.info('Push corresponds to a branch/tag deletion; skipping review.');
              return;
            }

            const commits = context.payload.commits ?? [];
            if (commits.length === 0) {
              core.info('No commits found in push payload.');
              return;
            }

            for (const commit of commits) {
              try {
                await github.rest.repos.createCommitComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  commit_sha: commit.id,
                  body: 'Automated review started for this commit. The automation will post feedback here if any issues are detected.'
                });
                core.info(`Started review for commit ${commit.id}`);
              } catch (error) {
                const message = error?.message ?? String(error);
                core.warning(`Failed to start review for commit ${commit.id}: ${message}`);
              }
            }
