name: Copilot Auto Review

on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  start-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Start review on pushed commits
        uses: actions/github-script@v7
        with:
          script: |
            if (context.payload.deleted) {
              core.info('Push corresponds to a branch/tag deletion; skipping review.');
              return;
            }

            const commits = context.payload.commits ?? [];
            if (commits.length === 0) {
              core.info('No commits found in push payload.');
              return;
            }

            const instruction = [
              '#### Copilot Review Instructions',
              '',
              'Focus the review on:',
              '- Code redundancy: unused variables, duplicate state, unnecessary effects.',
              '- Unoptimal React patterns: missing memoization, heavy computations in render, repeated fetches.',
              '- React best practices violations: incorrect hook dependencies, derived state anti-patterns, incorrect keys in lists, improper error/loading handling.',
              '- Smallest actionable changes: suggest precise removals or refactors (e.g., remove an unneeded `useEffect`, convert state to derived value, inline trivial wrappers).',
              '',
              'Also check:',
              '- Data fetching: use `AbortController`, avoid race conditions, handle `isLoading`/`error` explicitly.',
              '- Performance: function recreation; use `useCallback`/`useMemo` only when beneficial; avoid over-memoization.',
              '- Styling: Tailwind v4 usage (`@import "tailwindcss"`), remove unused classes.',
              '- HTTP: merge headers safely so defaults (e.g., `Content-Type`) arenâ€™t overridden.',
              '',
              'Output format:',
              '- List issues with file:line references and brief rationale.',
              '- Provide minimal diffs or one-liner suggestions where possible.'
            ].join('\n');

            for (const commit of commits) {
              try {
                await github.rest.repos.createCommitComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  commit_sha: commit.id,
                  body: instruction
                });
                core.info(`Posted Copilot review instructions for commit ${commit.id}`);
              } catch (error) {
                const status = error?.status ?? error?.response?.status;
                const message = error?.message ?? String(error);
                if (status === 404) {
                  core.info(`Commit ${commit.id} no longer exists (possibly due to a force push); skipping review. Original error: ${message}`);
                } else {
                  core.warning(`Failed to post instructions for commit ${commit.id}: ${message}`);
                }
              }
            }

  copilot-react-pr-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    if: github.event_name == 'pull_request'
    steps:
      - name: Post Copilot review instructions on PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info('No pull request found in event payload.');
              return;
            }

            const body = [
              '#### Copilot Review Instructions',
              '',
              'Please review this PR focusing on:',
              '- Code redundancy and smallest removals (unneeded state/effects, unused vars).',
              '- Unoptimal code and React performance pitfalls.',
              '- Violations of React best practices (hooks dependencies, derived state, list keys).',
              '',
              'Specific checks:',
              '- `useEffect`/`useMemo`/`useCallback`: unnecessary usage or missing deps; suggest removals.',
              '- Derived state: avoid duplicating props in state; compute when rendering.',
              '- Re-renders: function recreation; memoize only where it helps.',
              '- Data fetching: abort on re-renders/unmount; prevent races; clear errors/loading.',
              '- Tailwind v4: valid import; remove unused classes.',
              '- HTTP headers: merge defaults safely.',
              '',
              'Output:',
              '- Bullet list with file:line references and brief rationale.',
              '- Minimal diffs or one-liner suggestions.'
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            const existing = comments.find(c => c.user?.type === 'Bot' && c.body?.includes('Copilot Review Instructions'));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
              core.info('Updated existing Copilot review instruction comment.');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body
              });
              core.info('Created Copilot review instruction comment on PR.');
            }
